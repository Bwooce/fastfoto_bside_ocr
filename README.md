# FastFoto OCR - Photo Back Metadata Extraction

Extract dates, locations, and descriptive text from Epson FastFoto back-side scans (_b.jpg files) and update original photo EXIF metadata using Claude Vision AI.

## Overview

This system processes photo back scans (generated by Epson FastFoto scanners) to extract:

- **Dates and times** - Handwritten Spanish/English dates, machine-printed processing dates
- **Locations** - Venue names, cities, countries (with optional geocoding to GPS coordinates)
- **Roll and frame IDs** - Film processing metadata (Consumer format: ###-###, APS format: ID###-###)
- **Descriptive text** - Captions, people names, institutions, events

The system generates a **human-reviewable proposal file** showing before/after EXIF values, which you can edit before applying changes to your photos.

## Features

âœ… **LLM-powered OCR** - Superior handwriting recognition using Claude Vision
âœ… **Spanish primary** - Handles Spanish dates, text (85% of typical collections)
âœ… **Zone-based search** - Prioritizes bottom edge (50%+ of machine dates), center, handwritten
âœ… **Safe workflow** - Review proposal file before any changes, automatic backups
âœ… **Format-agnostic** - Flexible date parsing trusts Claude's understanding
âœ… **Rich EXIF support** - Writes EXIF, IPTC, and XMP fields (compatible with Lightroom, Photos, Google Photos)

## Requirements

### Software Dependencies

```bash
# Python 3.9+
pip install -r requirements.txt

# ExifTool (required for EXIF writing)
# macOS:
brew install exiftool

# Linux:
sudo apt-get install libimage-exiftool-perl

# Windows:
# Download from https://exiftool.org/
```

### Python Dependencies

```txt
anthropic>=0.40.0         # Claude Vision API
python-dateutil>=2.8.2    # Flexible date parsing
PyYAML>=6.0              # Config file parsing
Pillow>=10.0.0           # Image processing
```

### API Access

**Claude Vision API** via Read tool:
- Requires Claude Max subscription OR
- Anthropic API key with Claude Sonnet 4+ access

**Cost estimate** for 2000-3000 images: $30-75 (one-time)

## Installation

```bash
# Clone repository
git clone https://github.com/Bwooce/fastfoto_bside_ocr.git
cd fastfoto_bside_ocr

# Install dependencies
pip install -r requirements.txt

# Verify ExifTool installation
exiftool -ver

# Configure (optional - defaults work for most cases)
cp config.yaml.example config.yaml
# Edit config.yaml to adjust date ranges, known locations, etc.
```

## Usage

### Step 1: Generate Proposal

Scan your photo directory and generate a proposal file showing all proposed EXIF updates:

```bash
python src/orchestrator.py scan ~/Photos/FastFoto --output proposal.txt
```

**Options:**
- `--recursive` / `-r` - Search subdirectories (default: True)
- `--config` / `-c` - Custom config file path
- `--output` / `-o` - Output proposal filename

**Example output:**
```
Discovering photos in /Users/you/Photos/FastFoto (recursive=True)
Found 482 photo pairs
[1/482] Processing IMG_001.jpg
[2/482] Processing IMG_002.jpg
...

PROCESSING STATISTICS
================================================================================
Total photo pairs found:     482
Successfully processed:      451
With proposed updates:       289
Skipped (no useful data):    31
Errors:                      0

Success rate:                64.1%
================================================================================

Proposal file created: proposal.txt
```

### Step 2: Review Proposal

Open `proposal.txt` in your text editor and review each proposed update:

```txt
================================================================================
FastFoto OCR - EXIF Update Proposal
Generated: 2025-11-13 14:32:15
================================================================================

SUMMARY:
  Total files analyzed: 482
  Files with proposed updates: 289 (59.9%)
  Files without updates: 193

CONFIDENCE DISTRIBUTION:
  High (â‰¥0.8): 267 files
  Medium (0.6-0.8): 18 files
  Low (<0.6): 4 files
  Average confidence: 0.88

INSTRUCTIONS:
  1. Review each proposed update below
  2. Check for accuracy of extracted dates, locations, and text
  3. To skip an update, add "SKIP:" at the start of that section
  4. To modify a value, edit it directly in this file
  5. Save and run with: python src/orchestrator.py apply proposal.txt

================================================================================

[0001] IMG_001.jpg
  Back scan: IMG_001_b.jpg
  Confidence: 0.92

  CURRENT EXIF:
    DateTimeOriginal: <not set>

  PROPOSED UPDATES:
    DateTimeOriginal: 1999:06:07 11:32:00
    CreateDate: 1999:06:07 11:32:00
    GPSLatitude: 52, 5, 30.0
    GPSLatitudeRef: N
    GPSLongitude: 5, 7, 15.0
    GPSLongitudeRef: E
    LocationCreatedCity: Utrecht
    LocationCreatedCountryName: Netherlands
    Caption-Abstract: Summer vacation trip
    Keywords: vacation, 1999, Utrecht

  EXTRACTION METADATA:
    Source: Zone 1 (bottom edge)
    Language: en
    Zones with data: zone_1_bottom_edge, zone_4_handwritten

[0002] IMG_002.jpg
...
```

**To skip an update**, add `SKIP:` at the beginning:
```txt
SKIP: [0002] IMG_002.jpg
  ...
```

**To modify a value**, edit it directly:
```txt
  PROPOSED UPDATES:
    DateTimeOriginal: 1998:06:07 11:32:00  â† Changed from 1999 to 1998
```

### Step 3: Apply Updates

After reviewing and editing the proposal, apply the changes:

```bash
# Dry run (show what would happen, don't write)
python src/orchestrator.py apply proposal.txt --dry-run

# Apply for real
python src/orchestrator.py apply proposal.txt
```

**Backups**: ExifTool automatically creates `*_original` backup files. To disable:
```bash
# Add to config.yaml:
exiftool_options:
  overwrite_original: true
```

## Configuration

Edit `config.yaml` to customize behavior:

```yaml
# Date parsing
date_parsing:
  min_year: 1966          # Earliest expected photo year
  max_year: 2002          # Latest expected photo year

# Known locations (for faster geocoding)
known_locations:
  - name: "Hotel Dimitry Dallas"
    city: "Dallas"
    country: "United States"
    lat: 32.7767
    lon: -96.7970

# Processing
processing:
  max_workers: 4          # Parallel processing threads
  temp_dir: "/tmp"        # Temp file location

# Image preprocessing
image_processing:
  max_file_size_mb: 3.0   # Resize if larger
  max_dimension_px: 1800  # Max width/height
  jpeg_quality: 85        # Compression quality

# OCR confidence thresholds
ocr:
  min_confidence: 0.60    # Skip updates below this
  warn_confidence: 0.75   # Warn if below this
```

## EXIF Fields Written

### Date/Time
- `DateTimeOriginal` - Primary photo date (EXIF format: YYYY:MM:DD HH:MM:SS)
- `CreateDate`, `ModifyDate` - Set to same as DateTimeOriginal
- `OffsetTimeOriginal` - Timezone offset (calculated from GPS if available)

### GPS Location
- `GPSLatitude`, `GPSLatitudeRef` - Latitude (DMS format)
- `GPSLongitude`, `GPSLongitudeRef` - Longitude (DMS format)

### Location Text (IPTC Extension)
- `LocationCreatedLocationName` - Venue/landmark name
- `LocationCreatedCity` - City name
- `LocationCreatedCountryName` - Country name
- `LocationCreatedCountryCode` - ISO country code
- `LocationCreatedSublocation` - Neighborhood/district

### Descriptive Text
- `Caption-Abstract` - Photo caption (up to 1000 chars)
- `UserComment` - Full OCR text + confidence/language metadata (up to 2000 chars)
- `Keywords` - Searchable keywords (people, places, events, institutions)

### Film Processing
- `ImageUniqueID` - Film roll ID (###-### or ID###-###)
- `ImageNumber` - Frame number on roll
- `Make` - Processing lab code

See [`EXIF_FIELDS.md`](EXIF_FIELDS.md) for complete details.

## Architecture

```
src/
â”œâ”€â”€ orchestrator.py          # Main CLI and workflow coordination
â”œâ”€â”€ file_discovery.py        # Find and pair _b files with originals
â”œâ”€â”€ image_processor.py       # Resize images for Read tool constraints
â”œâ”€â”€ claude_prompts.py        # Prompt templates and response parsing
â”œâ”€â”€ date_parser.py           # Flexible date parsing (Spanish/English)
â”œâ”€â”€ exif_writer.py          # ExifTool wrapper for metadata writing
â””â”€â”€ proposal_generator.py    # Generate human-reviewable proposal files
```

**Workflow:**
1. **Discovery** - Find all `*_b.jpg` files and pair with originals
2. **Processing** - Resize images if needed (>3.5MB or >2000px)
3. **Analysis** - Send to Claude Vision with zone-based OCR prompt
4. **Extraction** - Parse dates, locations, text from Claude's response
5. **Proposal** - Generate before/after comparison file
6. **Review** - User edits proposal file
7. **Application** - Write approved EXIF updates via ExifTool

## Design Rationale

### Why Claude Vision over Traditional OCR?

**Traditional OCR** (Tesseract, PaddleOCR, Azure) struggles with:
- Handwritten text (65% of useful backs have it)
- Faint, small machine-printed text
- Multi-orientation text on same image
- Contextual understanding (is "1999" a date or just text?)

**Claude Vision** excels at:
- Handwriting recognition (trained on diverse datasets)
- Contextual understanding ("27 de Noviembre de 1983" â†’ date)
- Flexible extraction (no rigid format requirements)
- One API call per image (simpler than multi-stage pipelines)

**Test results** on 151 images:
- 84.8% successfully extracted dates
- 26.2% extracted location names
- Average confidence: 0.88
- Zero false positives on damaged/blank backs

### Why Zone-Based Search?

**Analysis of 151 photo backs revealed:**
- **50%+ have machine-printed dates** on bottom horizontal edge
- Often very small (1-3mm character height) and faint gray
- Easy to miss without explicit instruction to look there

**Zone priority:**
1. **Bottom edge** (highest priority) - Machine dates
2. **Center** - Handwritten dates/text
3. **Vertical edges** - Professional lab data
4. **Handwritten** - Spanish/English captions

This approach increased extraction rate from ~35% to 60%+.

### Why Proposal File Workflow?

**Safety and control:**
- OCR is not perfect (even at 88% confidence)
- User expertise needed for ambiguous cases
- Allows batch editing before committing changes
- Prevents accidental overwrites

## Troubleshooting

### Images not being processed

**Check:**
- File naming: Must be `*_b.jpg`, `*_b.JPG`, `*_b.tiff`, or `*_B.jpg`
- Pairing: Original must exist (e.g., `IMG_001.jpg` for `IMG_001_b.jpg`)
- Permissions: Read access to source directory

### Low confidence scores

**Common causes:**
- Damaged or water-stained backs
- Extremely faded text
- Non-text markings (film processing artifacts)

**Solutions:**
- Review proposal file - might still be useful at 0.60-0.75
- Adjust `min_confidence` in config.yaml to be more/less strict

### Wrong dates extracted

**Common issues:**
- Two-digit years: 02 â†’ 2002 or 1902?
  - Adjust `min_year`/`max_year` in config.yaml
- Filename dates override OCR dates
  - Edit proposal file to use OCR date instead

### Claude Vision API errors

**Rate limits:**
- Claude Max: ~50 requests/minute
- API key: Varies by tier

**Solutions:**
- Add delay between requests (config: `request_delay_ms`)
- Process in smaller batches

### ExifTool errors

**"ExifTool not found":**
```bash
# Verify installation
which exiftool
exiftool -ver

# If not installed, see Requirements section
```

**"Warning: [minor] errors":**
- Usually safe to ignore
- Check `fastfoto_ocr.log` for details

## Development

### Running Tests

```bash
# Test individual modules
python src/date_parser.py              # Test date parsing
python src/exif_writer.py IMG_001.jpg  # Test EXIF reading
python src/proposal_generator.py output.txt  # Test proposal generation

# Full integration test
python src/orchestrator.py scan test_samples/ --output test_proposal.txt
```

### Adding Custom Date Formats

Edit `src/date_parser.py`:

```python
def _parse_custom(self, date_str: str) -> Optional[datetime]:
    # Add your custom regex pattern
    my_pattern = r'(\d{4})-(\d{2})-(\d{2})'
    match = re.search(my_pattern, date_str)
    if match:
        yyyy, mm, dd = match.groups()
        return datetime(int(yyyy), int(mm), int(dd))

    # ... rest of existing patterns
```

### Adding Known Locations

Edit `config.yaml`:

```yaml
known_locations:
  - name: "My Venue Name"
    city: "City"
    country: "Country"
    lat: 12.3456
    lon: -78.9012
```

## Privacy & PII

**IMPORTANT:** Photo backs may contain personally identifiable information (PII):
- People's names
- Addresses
- Personal notes

**Protections in place:**
- `.gitignore` excludes all image files
- `.gitignore` excludes analysis/proposal files
- Temp files cleaned automatically
- No data sent anywhere except Claude Vision API

**User responsibilities:**
- Review proposal files before sharing
- Don't commit test samples to git
- Store backups securely

## Cost Estimation

**Claude Vision API** (via Claude Max subscription or API key):

| Collection Size | API Calls | Estimated Cost |
|----------------|-----------|----------------|
| 500 images | 500 | $7.50 - $12.50 |
| 1000 images | 1000 | $15 - $25 |
| 2000 images | 2000 | $30 - $50 |
| 3000 images | 3000 | $45 - $75 |

**Factors:**
- Image size (larger = higher cost)
- API tier (Max subscription vs. pay-per-use)
- Retry logic (failed requests)

**One-time cost** for most collections: Well under $100.

## Roadmap

### Phase 1: Core Functionality âœ…
- [x] File discovery and pairing
- [x] Image preprocessing (resize for Read tool)
- [x] Claude Vision integration
- [x] Spanish date parsing
- [x] Basic location extraction
- [x] Proposal file generation
- [x] ExifTool integration
- [x] CLI orchestrator

### Phase 2: Enhanced Features ðŸš§
- [ ] Venue geocoding with Nominatim
- [ ] Geocoding cache system
- [ ] Known location database matching
- [ ] Keyword extraction (names, institutions, events)
- [ ] Timezone calculation from coordinates
- [ ] Proposal file parser (for apply command)

### Phase 3: Polish
- [ ] Multi-processing for batch operations
- [ ] Progress bars and better logging
- [ ] Error recovery and retries
- [ ] Statistics and reporting dashboard
- [ ] GUI for proposal review/editing

### Phase 4: Optional
- [ ] APS format support (if needed)
- [ ] Multi-rotation OCR (if needed)
- [ ] Hybrid OCR strategy (PaddleOCR + Claude for cost optimization)

## Contributing

This is a personal project, but contributions welcome:

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly (don't commit PII!)
5. Submit a pull request

## License

MIT License - See LICENSE file

## Support

For issues or questions:
- GitHub Issues: https://github.com/Bwooce/fastfoto_bside_ocr/issues
- Documentation: See `DESIGN_REFINEMENTS.md` and `SYSTEM_DESIGN.md`

## Acknowledgments

- **Epson FastFoto FF-680W** - Scanner that inspired this project
- **Anthropic Claude** - Vision AI powering the OCR
- **ExifTool** by Phil Harvey - Industry-standard metadata tool
- **Test collection** - 151 images that refined the design

---

**Note:** This system is designed for personal photo collections. Always review proposals before applying changes to precious memories!
