# FastFoto OCR - Photo Back Metadata Extraction

Extract dates, locations, and descriptive text from Epson FastFoto back-side scans (_b.jpg files) and update original photo EXIF metadata using Claude Code's interactive Read tool.

## Overview

This system processes photo back scans (generated by Epson FastFoto scanners) to extract:

- **Dates and times** - Handwritten Spanish/English dates, machine-printed processing dates
- **Locations** - Venue names, cities, countries (with optional geocoding to GPS coordinates)
- **Roll and frame IDs** - Film processing metadata (Consumer format: ###-###, APS format: ID###-###)
- **Descriptive text** - Captions, people names, institutions, events

The system uses Claude Code's **single-step interactive workflow** - everything happens in one session.

## âœ¨ Interactive Workflow

**No API keys needed!** Uses Claude Code's Read tool with your Claude Max subscription.

### Single Command Process

Simply tell Claude Code where your FastFoto images are, and it handles everything:
- Automatically prepares images for analysis
- Processes all back scans with OCR
- Generates a proposal file for review
- Applies approved EXIF updates

## Features

âœ… **Claude Code integration** - Uses Read tool (no API costs with Claude Max)
âœ… **LLM-powered OCR** - Superior handwriting recognition using Claude Vision
âœ… **Spanish primary** - Handles Spanish dates, text (85% of typical collections)
âœ… **Zone-based search** - Prioritizes bottom edge (50%+ of machine dates), center, handwritten
âœ… **Safe workflow** - Review proposal file before any changes, automatic backups
âœ… **Format-agnostic** - Flexible date parsing trusts Claude's understanding
âœ… **Rich EXIF support** - Writes EXIF, IPTC, and XMP fields (compatible with Lightroom, Photos, Google Photos)

## Requirements

### Software Dependencies

```bash
# Python 3.9+
pip install -r requirements.txt

# ExifTool (required for EXIF writing)
# macOS:
brew install exiftool

# Linux:
sudo apt-get install libimage-exiftool-perl

# Windows:
# Download from https://exiftool.org/
```

### Python Dependencies

```txt
Pillow>=10.0.0           # Image processing
PyYAML>=6.0              # Config file parsing
python-dateutil>=2.8.0   # Flexible date parsing
tqdm>=4.65.0             # Progress bars
geopy>=2.3.0             # Geocoding (optional)
colorama>=0.4.6          # Colored terminal output
```

### Claude Code Access

**Required:**
- Claude Max subscription
- Claude Code CLI installed and authenticated

**Cost: $0** (uses your Claude Max subscription)

## Installation

```bash
# Clone repository
git clone https://github.com/Bwooce/fastfoto_bside_ocr.git
cd fastfoto_bside_ocr

# Install dependencies
pip install -r requirements.txt

# Verify ExifTool installation
exiftool -ver

# Configure (optional - defaults work for most cases)
cp config.yaml.example config.yaml
# Edit config.yaml to adjust date ranges, known locations, etc.
```

## Usage

### Single-Step Processing (Claude Code Session)

Start Claude Code and give it a simple command to process your entire FastFoto collection:

**You say:**
```
"Process my FastFoto images in ~/Photos/FastFoto and generate a proposal file"
```

**Claude Code will automatically process your COMPLETE collection:**
1. **Discover** all `*_b.jpg` files in your directory
2. **Preprocess** images (resize >3.5MB or >2000px to 1800px @ 85% quality)
3. **Analyze EVERY SINGLE back scan** using OCR with Claude Vision (no samples or demonstrations)
4. **Extract** dates, locations, people, and descriptive text from each individual image
5. **Generate** proposal file showing all proposed EXIF updates for entire collection
6. **Display** statistics and next steps

**Important:** Claude Code will process your entire collection without pausing for optimization suggestions. Processing time depends on collection size (allow ~10-18 seconds per image). Enhancement ideas will be provided after processing is complete.

**Example session:**
```
You: "Process my FastFoto images in ~/Photos/FastFoto and generate a proposal file"

Claude: I'll process your FastFoto collection. Let me start by preprocessing the images...

Running preprocessing script...
================================================================================
FastFoto Back Scan Preprocessor
================================================================================
Found 482 back scans to preprocess
Processing: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 482/482 [00:45<00:00, 10.67it/s]

âœ“ Preprocessing complete!
- Total: 482 back scans
- Resized: 127 (too large)
- Size reduction: 68.7% (2847MB â†’ 892MB)

Now analyzing each back scan with OCR...

Processing: [1/482] IMG_001_b.jpg... âœ“ (date: 1999-06-07, location: Utrecht)
Processing: [2/482] IMG_002_b.jpg... âœ“ (date: 2001-03-15)
Processing: [3/482] IMG_003_b.jpg... âš  (confidence: 0.58, no useful data)
...

Analysis complete!
- 482 photos analyzed
- 289 with useful metadata (60%)
- 193 without useful data (40%)
- Average confidence: 0.88

âœ“ Proposal created: exif_updates_proposal.txt

Please review the proposal file and make any edits. When ready, say "apply the proposal"
to update your photos.
```

### Review Proposal

Open `exif_updates_proposal.txt` in your text editor and review each proposed update:

```txt
================================================================================
FastFoto OCR - EXIF Update Proposal
Generated: 2025-11-13 14:32:15
================================================================================

SUMMARY:
  Total files analyzed: 482
  Files with proposed updates: 289 (59.9%)
  Files without updates: 193

CONFIDENCE DISTRIBUTION:
  High (â‰¥0.8): 267 files
  Medium (0.6-0.8): 18 files
  Low (<0.6): 4 files
  Average confidence: 0.88

INSTRUCTIONS:
  1. Review each proposed update below
  2. Check for accuracy of extracted dates, locations, and text
  3. To skip an update, add "SKIP:" at the start of that section
  4. To modify a value, edit it directly in this file
  5. Save and run apply command via Claude Code

================================================================================

[0001] IMG_001.jpg
  Back scan: IMG_001_b.jpg
  Confidence: 0.92

  CURRENT EXIF:
    DateTimeOriginal: <not set>

  PROPOSED UPDATES:
    DateTimeOriginal: 1999:06:07 11:32:00
    CreateDate: 1999:06:07 11:32:00
    GPSLatitude: 52, 5, 30.0
    GPSLatitudeRef: N
    GPSLongitude: 5, 7, 15.0
    GPSLongitudeRef: E
    LocationCreatedCity: Utrecht
    LocationCreatedCountryName: Netherlands
    Caption-Abstract: Summer vacation trip
    Keywords: vacation, 1999, Utrecht

  EXTRACTION METADATA:
    Source: Zone 1 (bottom edge)
    Language: en
    Zones with data: zone_1_bottom_edge, zone_4_handwritten

[0002] IMG_002.jpg
...
```

**To skip an update**, add `SKIP:` at the beginning:
```txt
SKIP: [0002] IMG_002.jpg
  ...
```

**To modify a value**, edit it directly:
```txt
  PROPOSED UPDATES:
    DateTimeOriginal: 1998:06:07 11:32:00  â† Changed from 1999 to 1998
```

### Apply Updates (Same Session)

After reviewing and editing the proposal, continue in the same Claude Code session:

**You say:**
```
"Apply the proposal file"
```

**Claude Code will:**
1. Parse the proposal file
2. Skip entries marked with `SKIP:`
3. Apply EXIF updates to **original photos** (clean updates, no backup files)
4. Move processed back scan files to `processed/` subdirectories
5. Report results

**Example output:**
```
You: "Apply the proposal file"

Claude: Applying EXIF updates from proposal file to original photos...

================================================================================
APPLY PROPOSAL RESULTS
================================================================================
âœ… Photos updated:        289
ðŸ“ Back scans organized:  287
â­ï¸  Entries skipped:       2
âŒ Errors:               0
================================================================================

âœ¨ Processed back scans moved to 'processed/' subdirectories
ðŸ’¡ Tip: To reprocess, move files back from processed/ directories

Done! Your photos now have updated EXIF metadata and processed back scans are organized.
```

## File Organization

### Before Processing
```
~/Photos/FastFoto/
â”œâ”€â”€ IMG_001.jpg          # Original photo
â”œâ”€â”€ IMG_001_b.jpg        # Back scan
â”œâ”€â”€ IMG_002.jpg          # Original photo
â”œâ”€â”€ IMG_002_b.jpg        # Back scan
â””â”€â”€ Vacation_2023/
    â”œâ”€â”€ IMG_003.jpg
    â”œâ”€â”€ IMG_003_b.jpg
    â”œâ”€â”€ IMG_004.jpg
    â””â”€â”€ IMG_004_b.jpg
```

### After Processing
```
~/Photos/FastFoto/
â”œâ”€â”€ IMG_001.jpg          # âœ… Updated with EXIF metadata
â”œâ”€â”€ IMG_002.jpg          # âœ… Updated with EXIF metadata
â”œâ”€â”€ processed/
â”‚   â”œâ”€â”€ IMG_001_b.jpg    # ðŸ“ Moved after successful processing
â”‚   â””â”€â”€ IMG_002_b.jpg    # ðŸ“ Moved after successful processing
â””â”€â”€ Vacation_2023/
    â”œâ”€â”€ IMG_003.jpg      # âœ… Updated with EXIF metadata
    â”œâ”€â”€ IMG_004.jpg      # âœ… Updated with EXIF metadata
    â””â”€â”€ processed/
        â”œâ”€â”€ IMG_003_b.jpg
        â””â”€â”€ IMG_004_b.jpg
```

**Benefits:**
- âœ… **Clean workspace**: Only original photos remain in main directories
- âœ… **Clear tracking**: Moved files = successfully processed
- âœ… **No backup clutter**: No `*_original` files created
- âœ… **Reprocessing option**: Move files back from `processed/` if needed
- âœ… **Hierarchical organization**: Each directory gets its own `processed/` subdirectory

## Configuration

Edit `config.yaml` to customize behavior:

```yaml
# Date parsing
date_parsing:
  min_year: 1966          # Earliest expected photo year
  max_year: 2002          # Latest expected photo year

# Known locations (for faster geocoding)
known_locations:
  - name: "Hotel Dimitry Dallas"
    city: "Dallas"
    country: "United States"
    lat: 32.7767
    lon: -96.7970

# Image preprocessing
image_processing:
  max_file_size_mb: 3.0   # Resize if larger
  max_dimension_px: 1800  # Max width/height
  jpeg_quality: 85        # Compression quality

# OCR confidence thresholds
ocr:
  min_confidence: 0.60    # Skip updates below this
  warn_confidence: 0.75   # Warn if below this
```

## EXIF Fields Written

### Date/Time
- `DateTimeOriginal` - Primary photo date (EXIF format: YYYY:MM:DD HH:MM:SS)
- `CreateDate`, `ModifyDate` - Set to same as DateTimeOriginal
- `OffsetTimeOriginal` - Timezone offset (calculated from GPS if available)

### GPS Location
- `GPSLatitude`, `GPSLatitudeRef` - Latitude (DMS format)
- `GPSLongitude`, `GPSLongitudeRef` - Longitude (DMS format)

### Location Text (IPTC Extension)
- `LocationCreatedLocationName` - Venue/landmark name
- `LocationCreatedCity` - City name
- `LocationCreatedCountryName` - Country name
- `LocationCreatedCountryCode` - ISO country code
- `LocationCreatedSublocation` - Neighborhood/district

### Descriptive Text
- `Caption-Abstract` - Photo caption (up to 1000 chars)
- `UserComment` - Full OCR text + confidence/language metadata (up to 2000 chars)
- `Keywords` - Searchable keywords (people, places, events, institutions)

### Film Processing
- `ImageUniqueID` - Film roll ID (###-### or ID###-###)
- `ImageNumber` - Frame number on roll
- `Make` - Processing lab code

See [`EXIF_FIELDS.md`](EXIF_FIELDS.md) for complete details.

## Architecture

### Single-Step Interactive Workflow

```
Claude Code Session
â”œâ”€â”€ Runs preprocessing via Bash tool (src/preprocess_images.py)
â”œâ”€â”€ Uses file_discovery.py to find *_b.jpg files
â”œâ”€â”€ Uses image_processor.py to resize/convert images
â”œâ”€â”€ Creates preprocessing_mapping.json
â”œâ”€â”€ Uses Read tool on each prepared image
â”œâ”€â”€ Uses interactive_processor.py helper for coordination
â”œâ”€â”€ Generates proposal via proposal_generator.py
â””â”€â”€ Applies updates via exif_writer.py (when requested)
```

**Core Modules:**
```
src/
â”œâ”€â”€ preprocess_images.py     # NEW: Standalone preprocessing script
â”œâ”€â”€ interactive_processor.py # NEW: Helper for Claude Code sessions
â”œâ”€â”€ file_discovery.py        # Find and pair _b files with originals
â”œâ”€â”€ image_processor.py       # Resize images for Read tool constraints
â”œâ”€â”€ claude_prompts.py        # Prompt templates and response parsing
â”œâ”€â”€ date_parser.py           # Flexible date parsing (Spanish/English)
â”œâ”€â”€ exif_writer.py          # ExifTool wrapper for metadata writing
â”œâ”€â”€ proposal_generator.py    # Generate human-reviewable proposal files
â””â”€â”€ orchestrator.py          # Legacy - may be removed
```

## Design Rationale

### Why Single-Step Interactive Process?

**Benefits:**
- **Simple UX**: One command does everything
- **No temp management**: Claude handles preprocessing automatically
- **Error recovery**: Can fix preprocessing issues in same session
- **Seamless workflow**: No context switching between tools
- **Clean organization**: Processed back scans moved to `processed/` subdirectories
- **No backup clutter**: Clean EXIF updates without `*_original` files
- **Cost-effective**: $0 using Claude Max subscription

### Why Claude Code vs. API?

**Claude Code advantages:**
- âœ… No API key management
- âœ… No separate API costs (uses Claude Max)
- âœ… Interactive workflow with user control
- âœ… Built-in image reading capabilities
- âŒ Requires active session (not standalone)

### Why Claude Vision over Traditional OCR?

**Traditional OCR** (Tesseract, PaddleOCR, Azure) struggles with:
- Handwritten text (65% of useful backs have it)
- Faint, small machine-printed text
- Multi-orientation text on same image
- Contextual understanding (is "1999" a date or just text?)

**Claude Vision** excels at:
- Handwriting recognition (trained on diverse datasets)
- Contextual understanding ("27 de Noviembre de 1983" â†’ date)
- Flexible extraction (no rigid format requirements)
- One API call per image (simpler than multi-stage pipelines)

**Test results** on 151 images:
- 84.8% successfully extracted dates
- 26.2% extracted location names
- Average confidence: 0.88
- Zero false positives on damaged/blank backs

### Why Zone-Based Search?

**Analysis of 151 photo backs revealed:**
- **50%+ have machine-printed dates** on bottom horizontal edge
- Often very small (1-3mm character height) and faint gray
- Easy to miss without explicit instruction to look there

**Zone priority:**
1. **Bottom edge** (highest priority) - Machine dates
2. **Center** - Handwritten dates/text
3. **Vertical edges** - Professional lab data
4. **Handwritten** - Spanish/English captions

This approach increased extraction rate from ~35% to 60%+.

### Why Proposal File Workflow?

**Safety and control:**
- OCR is not perfect (even at 88% confidence)
- User expertise needed for ambiguous cases
- Allows batch editing before committing changes
- Prevents accidental overwrites

## Troubleshooting

### Preprocessing Issues

**"No back scans found":**
- Check file naming: Must be `*_b.jpg`, `*_b.JPG`, `*_b.tiff`, or `*_B.jpg`
- Verify source directory path
- Use `--verbose` flag for detailed discovery info

**Large file size reduction:**
- Expected behavior - optimizes for Claude Code Read tool
- Original images remain untouched
- Adjust `max_file_size_mb` and `jpeg_quality` in config if needed

### Claude Code Session Issues

**"Mapping file not found":**
- Ensure preprocessing step completed successfully
- Check output directory path matches what you tell Claude Code

**Analysis taking too long:**
- Expected for large collections (482 images = ~45+ minutes)
- Claude Code processes images sequentially
- Can pause/resume session if needed

### Low confidence scores

**Common causes:**
- Damaged or water-stained backs
- Extremely faded text
- Non-text markings (film processing artifacts)

**Solutions:**
- Review proposal file - might still be useful at 0.60-0.75
- Adjust `min_confidence` in config.yaml to be more/less strict

### Wrong dates extracted

**Common issues:**
- Two-digit years: 02 â†’ 2002 or 1902?
  - Adjust `min_year`/`max_year` in config.yaml
- Edit proposal file to correct dates before applying

### ExifTool errors

**"ExifTool not found":**
```bash
# Verify installation
which exiftool
exiftool -ver

# If not installed, see Requirements section
```

**"Warning: [minor] errors":**
- Usually safe to ignore
- Check logs for details

## Development

### Testing the Workflow

```bash
# Test preprocessing with small sample
python src/preprocess_images.py test_samples/ --output /tmp/test_prepared

# Then test Claude Code session with prepared images
# (Interactive - follow workflow above)
```

### Module Testing

```bash
# Test individual modules
python src/date_parser.py              # Test date parsing
python src/exif_writer.py IMG_001.jpg  # Test EXIF reading
python src/proposal_generator.py output.txt  # Test proposal generation
```

### Adding Custom Date Formats

Edit `src/date_parser.py`:

```python
def _parse_custom(self, date_str: str) -> Optional[datetime]:
    # Add your custom regex pattern
    my_pattern = r'(\d{4})-(\d{2})-(\d{2})'
    match = re.search(my_pattern, date_str)
    if match:
        yyyy, mm, dd = match.groups()
        return datetime(int(yyyy), int(mm), int(dd))

    # ... rest of existing patterns
```

### Adding Known Locations

Edit `config.yaml`:

```yaml
known_locations:
  - name: "My Venue Name"
    city: "City"
    country: "Country"
    lat: 12.3456
    lon: -78.9012
```

## Privacy & PII

**IMPORTANT:** Photo backs may contain personally identifiable information (PII):
- People's names
- Addresses
- Personal notes

**Protections in place:**
- `.gitignore` excludes all image files
- `.gitignore` excludes analysis/proposal files
- Temp files cleaned automatically
- Data only processed locally and via Claude Code Read tool

**User responsibilities:**
- Review proposal files before sharing
- Don't commit test samples to git
- Store backups securely

## Cost

**FREE!** ðŸŽ‰

When using Claude Max subscription with Claude Code:
- No API costs
- No per-image charges
- Unlimited processing (subject to Claude Max usage policies)

Compare to previous API approach:
| Collection Size | Old API Cost | New Cost |
|----------------|-------------|----------|
| 500 images | $7.50 - $12.50 | **$0** |
| 1000 images | $15 - $25 | **$0** |
| 2000 images | $30 - $50 | **$0** |
| 3000 images | $45 - $75 | **$0** |

## Roadmap

### Phase 2: Enhanced Features (Current) ðŸš§
- [x] Two-step workflow design
- [x] Preprocessing script
- [x] Claude Code integration
- [x] Interactive processor helper
- [x] Updated documentation
- [ ] Proposal file parser for apply command
- [ ] Apply functionality testing

### Phase 3: Polish
- [ ] Progress tracking improvements
- [ ] Error recovery and retries
- [ ] Statistics and reporting dashboard
- [ ] Venue geocoding with Nominatim
- [ ] Known location database matching

### Phase 4: Optional
- [ ] GUI for proposal review/editing
- [ ] Multi-processing optimizations
- [ ] APS format support (if needed)
- [ ] Hybrid OCR strategy (cost optimization)

## Contributing

This is a personal project, but contributions welcome:

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly (don't commit PII!)
5. Submit a pull request

## License

MIT License - See LICENSE file

## Support

For issues or questions:
- GitHub Issues: https://github.com/Bwooce/fastfoto_bside_ocr/issues
- Documentation: See `DESIGN_REFINEMENTS.md` and `SYSTEM_DESIGN.md`

## Acknowledgments

- **Epson FastFoto FF-680W** - Scanner that inspired this project
- **Anthropic Claude Code** - Interactive AI development environment
- **Anthropic Claude Vision** - AI powering the OCR analysis
- **ExifTool** by Phil Harvey - Industry-standard metadata tool
- **Test collection** - 151 images that refined the design

---

**Note:** This system is designed for personal photo collections. Always review proposals before applying changes to precious memories!